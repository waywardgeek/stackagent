<!DOCTYPE html>
<html>
<head>
    <title>StackAgent Phase 1 Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .log { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .operation { background-color: #e9ecef; padding: 8px; margin: 5px 0; border-radius: 3px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .metrics { display: flex; gap: 20px; margin: 20px 0; }
        .metric { text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ StackAgent Phase 1 Test</h1>
        
        <div id="connectionStatus" class="status warning">
            üîÑ Connecting to WebSocket...
        </div>
        
        <div class="metrics">
            <div class="metric">
                <strong id="activeOps">0</strong><br>
                <small>Active Operations</small>
            </div>
            <div class="metric">
                <strong id="totalOps">0</strong><br>
                <small>Total Operations</small>
            </div>
            <div class="metric">
                <strong id="avgResponse">0ms</strong><br>
                <small>Avg Response Time</small>
            </div>
        </div>
        
        <div>
            <button onclick="testMessage()">Send Test Message</button>
            <button onclick="testFunctionCall()">Simulate Function Call</button>
            <button onclick="testShellCommand()">Simulate Shell Command</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="activeOperations">
            <h3>üîÑ Active Operations</h3>
            <div id="operationsList"></div>
        </div>
        
        <div id="log" class="log">
            <h3>üìù WebSocket Log</h3>
        </div>
    </div>

    <script>
        let websocket;
        let sessionId = 'test_session';
        let operationCount = 0;
        let totalOperations = 0;
        let activeOperations = new Map();
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateMetrics() {
            document.getElementById('activeOps').textContent = activeOperations.size;
            document.getElementById('totalOps').textContent = totalOperations;
            document.getElementById('avgResponse').textContent = '~1.2s'; // Placeholder
        }
        
        function updateOperationsList() {
            const list = document.getElementById('operationsList');
            if (activeOperations.size === 0) {
                list.innerHTML = '<div style="color: #666;">No active operations</div>';
                return;
            }
            
            let html = '';
            for (const [id, op] of activeOperations) {
                const elapsed = Math.floor((Date.now() - op.startTime) / 1000);
                html += `
                    <div class="operation">
                        <strong>${op.type}:</strong> ${op.name}
                        <span style="float: right;">‚è±Ô∏è ${elapsed}s</span>
                    </div>
                `;
            }
            list.innerHTML = html;
        }
        
        function connectWebSocket() {
            websocket = new WebSocket('ws://localhost:8080/ws');
            
            websocket.onopen = function(event) {
                log('‚úÖ WebSocket connected successfully', 'success');
                document.getElementById('connectionStatus').className = 'status success';
                document.getElementById('connectionStatus').textContent = '‚úÖ Connected to StackAgent';
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log(`üì® Received: ${data.type}`, 'info');
                    
                    switch(data.type) {
                        case 'session_started':
                            sessionId = data.data.sessionId;
                            log(`üéØ Session started: ${sessionId}`, 'success');
                            break;
                            
                        case 'function_call_started':
                            activeOperations.set(data.data.id, {
                                type: 'function',
                                name: data.data.name,
                                startTime: Date.now()
                            });
                            log(`üîß Function call started: ${data.data.name}`, 'info');
                            break;
                            
                        case 'function_call_streaming':
                            log(`üìä Function streaming: ${data.data.id}`, 'info');
                            break;
                            
                        case 'function_call_completed':
                            activeOperations.delete(data.data.id);
                            totalOperations++;
                            log(`‚úÖ Function completed: ${data.data.id}`, 'success');
                            break;
                            
                        case 'shell_command_started':
                            activeOperations.set(data.data.id, {
                                type: 'shell',
                                name: data.data.command,
                                startTime: Date.now()
                            });
                            log(`üíª Shell command started: ${data.data.command}`, 'info');
                            break;
                            
                        case 'shell_command_completed':
                            activeOperations.delete(data.data.id);
                            totalOperations++;
                            log(`‚úÖ Shell command completed: ${data.data.id}`, 'success');
                            break;
                            
                        case 'ping':
                            // Respond to ping
                            websocket.send(JSON.stringify({
                                type: 'pong',
                                data: null,
                                timestamp: new Date(),
                                sessionId: sessionId
                            }));
                            log('üèì Ping/Pong', 'info');
                            break;
                            
                        default:
                            log(`‚ùì Unknown message type: ${data.type}`, 'warning');
                    }
                    
                    updateMetrics();
                    updateOperationsList();
                    
                } catch (error) {
                    log(`‚ùå Error parsing message: ${error.message}`, 'error');
                }
            };
            
            websocket.onclose = function(event) {
                log('üîå WebSocket disconnected', 'error');
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectionStatus').textContent = '‚ùå Disconnected';
            };
            
            websocket.onerror = function(error) {
                log(`‚ùå WebSocket error: ${error}`, 'error');
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectionStatus').textContent = '‚ùå Connection Error';
            };
        }
        
        function sendMessage(type, data) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const message = {
                    type: type,
                    data: data,
                    timestamp: new Date(),
                    sessionId: sessionId
                };
                websocket.send(JSON.stringify(message));
                log(`üì§ Sent: ${type}`, 'info');
            } else {
                log('‚ùå WebSocket not connected', 'error');
            }
        }
        
        function testMessage() {
            sendMessage('chat_message', {
                message: 'Hello from Phase 1 test!',
                id: Date.now().toString()
            });
        }
        
        function testFunctionCall() {
            const id = `func_${Date.now()}`;
            sendMessage('function_call_started', {
                id: id,
                name: 'test_function',
                arguments: { test: true }
            });
            
            // Simulate completion after 3 seconds
            setTimeout(() => {
                sendMessage('function_call_completed', {
                    id: id,
                    result: 'Test function completed successfully'
                });
            }, 3000);
        }
        
        function testShellCommand() {
            const id = `shell_${Date.now()}`;
            sendMessage('shell_command_started', {
                id: id,
                command: 'echo "Hello from test shell command"'
            });
            
            // Simulate completion after 2 seconds
            setTimeout(() => {
                sendMessage('shell_command_completed', {
                    id: id,
                    output: 'Hello from test shell command',
                    exitCode: 0
                });
            }, 2000);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<h3>üìù WebSocket Log</h3>';
        }
        
        // Auto-update operations list every second
        setInterval(updateOperationsList, 1000);
        
        // Connect when page loads
        window.onload = function() {
            connectWebSocket();
            updateMetrics();
            updateOperationsList();
        };
    </script>
</body>
</html> 